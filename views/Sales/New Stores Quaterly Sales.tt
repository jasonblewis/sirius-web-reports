[% USE Dumper %]
[% USE date(format = '%Y-%m-%d') %]
<script src="/javascripts/datatablesdisplay.js"></script>

<h1>New Stores Quaterly Sales</h1>

<ol>
    [% FOREACH server IN servers %]
        <li>    server: [% server.name %]</li>
    [% END  %]
</ol>
<ol>
    [% FOREACH database IN databases %]
        <li>database: [% database.name %]</li>
    [% END  %]
</ol>

[% # Dumper.dump(fields) %]
<h2>Fields</h2>
<ul>
    [% FOREACH field IN fields %]
        <li>field: [% field %]</li>
    [% END  %]
</ul>

[% FOREACH row IN rows %]
    [% IF row.firstorderquater != loop.prev.firstorderquater;
       new_stores = 0;
       sum_gp = 0;
       sum_sales = 0;
       q_sum_gp = 0;
       q_sum_sales = 0;
    %]
        <h3>Quarter starting [% date.format(row.firstorderquater) %]</h3> 
        <table id="" class="display compact" cellspacing="0" width="90%">
            <thead>
                <tr>
                    <td>Customer Code</td>
                    <td>name</td>
                    <td class="right">first order<br />invoice date</td>
                    <td>sales rep</td>
                    <td>territory</td>
                    <td class="right">profit</td>
                    <td class="right">sales_amt</td>
                    <td class="right">gross profit</td>
                </tr>
            </thead>
            <tbody>
    [% END %]
    [%-
       sum_gp = sum_gp + row.profit_amt;
       sum_sales = sum_sales + row.sales_amt;
       q_sum_gp = q_sum_gp + row.profit_amt;
       q_sum_sales = q_sum_sales + row.sales_amt;
    -%]
    [% IF row.customer_code != loop.next.customer_code;
       new_stores = new_stores + 1;
    %]
        <tr>
            <td>[% row.customer_code %]</td>
            <td>[% row.name %]</td>
            <td class="right">[% date.format(row.first_order_inv_date) %]</td>
            <td>[% row.sales_rep_code %]</td>
            <td>[% row.territory_code %]</td>
            <td class="fp_number">[% sum_gp | format('%.2f') %]</td>
            <td class="fp_number">[% sum_sales | format('%.2f') %]</td>
            <td class="right">[% IF (sum_sales > 0) ;
                   sum_gp / sum_sales * 100 | format('%.0f');
                   ELSE;
                   "N/A";
                END; %]</td>
        </tr>
        [% sum_gp = 0;
           sum_sales = 0;
        %]
    [% END %] 
    
    [% IF row.firstorderquater != loop.next.firstorderquater; %]
            </tbody>
            <tfoot>
                <tr>
                    <td></td>
                    <td>New Stores: [% new_stores %]</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="total">[% q_sum_gp | format('%.2f') %]</td>
                    <td class="total">[% q_sum_sales | format('%.2f') %]</td>
                    <td class="total">[% IF (q_sum_sales > 0) ;
                               q_sum_gp / q_sum_sales * 100 | format('%.0f');
                               ELSE;
                               "N/A";
                               END; %]</td>
                </tr>
            </tfoot>
        </table>
        
        [% new_stores = 0;
           q_sum_gp = 0;
           q_sum_sales = 0;
        %]
    [% END %]
[% END %]
